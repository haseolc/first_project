# 1-3. Security Group 설정

이 단계에서는 **EC2 인스턴스에 어떤 네트워크 접근을 허용할 것인지 정의한다.**

Security Group은 서버의 “방화벽 역할”을 한다.

본 프로젝트에서는 **2개의 Security Group**을 사용한다.

# 1️⃣ SSH 보안 그룹 (ssh_sg)

### 목적

- EC2에 원격 접속(SSH)하기 위함이다.
- GitHub Actions가 Ansible을 실행하기 위해 반드시 필요하다.

### 허용 규칙

- Inbound
    - `22/tcp`
    - `0.0.0.0/0` (모든 IP 허용)
- Outbound
    - 모든 트래픽 허용

### 의미

- 외부 어디에서든 SSH 접속이 가능하다.
- 데모 및 개발 환경에서는 편리하다.
- 운영 환경에서는 특정 IP만 허용하는 것이 바람직하다.

# 2️⃣ WEB / 클러스터 보안 그룹 (web_sg)

### 목적

- HTTP/HTTPS 접근 허용
- Kubernetes 내부 통신 허용
- NodePort 접근 허용

---

### 허용 규칙

### 외부 접근 허용

- `80/tcp` (HTTP)
- `443/tcp` (HTTPS)
- `30080/tcp` (NodePort HTTP)
- `30443/tcp` (NodePort HTTPS)

→ `0.0.0.0/0` 허용

---

### 클러스터 내부 통신 허용

- `6443/tcp` (Kubernetes API)
- self traffic (같은 SG 간 전체 허용)

---

### SSH 그룹과 연동

- 22/tcp를 `ssh_sg`에서만 허용

---

### Outbound

- 모든 트래픽 허용

# 3️⃣ 왜 Security Group을 두 개로 나누는가

- SSH 접근과 웹/서비스 접근을 분리하기 위함이다.
- 역할이 다르기 때문에 관리가 명확해진다.
- 추후 보안 강화 시 SSH만 제한하는 등 조정이 쉽다.

# 4️⃣ 운영 방식 (중요)

Terraform을 반복 실행하면 Security Group이 계속 생성될 수 있다.

따라서 현재 팀은 다음과 같은 방식을 사용한다.

1. 최초 1회 `sg.tf`를 실행하여 보안 그룹 2개를 생성한다.
2. 이후에는 `sg.tf`를 비활성화한다.
3. EC2 생성 시에는 `data`로 기존 SG를 조회하여 재사용한다.

이 방식의 목적은 다음과 같다.

- 보안 그룹이 중복 생성되는 문제를 방지한다.
- 여러 인스턴스를 생성해도 동일한 SG를 사용하게 한다.

이 단계가 완료되면 EC2는 외부에서 접근 가능한 상태가 된다.
