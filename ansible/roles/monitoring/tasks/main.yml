---
# 1. 네임스페이스 생성
- name: "모니터링(monitoring) 네임스페이스 생성"
  ansible.builtin.shell: |
    /usr/local/bin/kubectl create namespace monitoring || true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: ns_create
  changed_when: "'created' in ns_create.stdout"

# 2. Helm 저장소 설정
- name: "Prometheus Community 저장소 추가 및 업데이트"
  ansible.builtin.shell: |
    /usr/local/bin/helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    /usr/local/bin/helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: true

# 3. 경량화 및 최적화된 모니터링 스택 설치
# 주석은 명령어(shell) 블록 밖에 작성해야 에러가 나지 않습니다.
#      --set grafana.adminPassword=admin123 \ 은 실질적으론 작동 안함, root 계정 용
- name: "경량화된 kube-prometheus-stack 설치"
  ansible.builtin.shell: |
    /usr/local/bin/helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --set grafana.adminPassword=admin123 \
      --set grafana.service.type=NodePort \
      --set grafana.service.nodePort=30000 \
      --set "grafana.grafana\.ini.auth\.anonymous.enabled=true" \
      --set "grafana.grafana\.ini.auth\.anonymous.org_name=Main Org." \
      --set "grafana.grafana\.ini.auth\.anonymous.org_role=Admin" \
      --set prometheus.prometheusSpec.retention=1d \
      --set prometheus.prometheusSpec.resources.limits.memory=512Mi \
      --set prometheus.prometheusSpec.resources.requests.memory=256Mi \
      --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.accessModes={ReadWriteOnce} \
      --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=5Gi \
      --set alertmanager.enabled=false \
      --set prometheus-node-exporter.resources.limits.memory=50Mi \
      --set kube-state-metrics.resources.limits.memory=100Mi
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: true

# 4. 설치 후 Pod 안정화 대기
- name: "모니터링 Pod 부팅 대기 (60초)"
  ansible.builtin.pause:
    seconds: 40

# 5. 대시보드 JSON 파일을 서버로 복사 (가장 확실한 경로 지정 방식)
- name: "대시보드 JSON 파일들을 서버로 전송"
  ansible.builtin.copy:
    # role_path를 쓰면 앤서블이 무조건 현재 role 폴더(monitoring)에서 시작합니다.
    src: "{{ role_path }}/templates/{{ item.name }}.json"
    dest: "/tmp/{{ item.name }}.json"
    owner: ec2-user
    group: ec2-user
    mode: '0644'
  loop:
    - { name: 'waf-dashboard' }
    - { name: 'node-dashboard' }
    - { name: 'k3s-dashboard' }

# 6. 복사된 파일을 이용해 ConfigMap 생성 및 배포 (Server-Side Apply 적용)
- name: "멀티 대시보드 배포 (Nginx/Node/Cluster)"
  ansible.builtin.shell: |
    /usr/local/bin/kubectl create configmap dashboard-{{ item.id }} \
      --from-file={{ item.name }}.json=/tmp/{{ item.name }}.json \
      -n monitoring --dry-run=client -o yaml | \
    /usr/local/bin/kubectl label -f - grafana_dashboard="1" --local -o yaml | \
    /usr/local/bin/kubectl apply --server-side --force-conflicts -f -
  loop:
    - { id: '9614', name: 'waf-dashboard' }
    - { id: '1860', name: 'node-dashboard' }
    - { id: '10856', name: 'k3s-dashboard' }
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

# 7. 사용이 끝난 임시 파일 삭제 (보안 및 정리)
- name: "임시 JSON 파일 삭제"
  ansible.builtin.file:
    path: "/tmp/{{ item.name }}.json"
    state: absent
  loop:
    - { name: 'waf-dashboard' }
    - { name: 'node-dashboard' }
    - { name: 'k3s-dashboard' }