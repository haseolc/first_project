---
- name: "Nginx Ingress WAF 컨트롤러 설치 (통합 및 기본 클래스 설정)"
  kubernetes.core.helm:
    name: nginx-waf
    chart_ref: ingress-nginx
    chart_repo_url: https://kubernetes.github.io/ingress-nginx
    release_namespace: ingress-nginx
    create_namespace: true
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    values:
      controller:
        kind: DaemonSet
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet
        admissionWebhooks: { enabled: false }
        service: { type: ClusterIP }
         # --- [추가된 Metrics 설정] ---
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            additionalLabels:
              # 앤서블 monitoring 역할에서 설치한 헬름 릴리즈 이름(prometheus)과 일치해야 함
              release: prometheus 
        # ----------------------------
        # ★ [핵심 수정] 이 컨트롤러를 기본 인그레스 관리자로 지정
        ingressClassResource:
          name: nginx
          enabled: true
          default: true
          controllerValue: "k8s.io/ingress-nginx"
        # 클래스 지정이 없는 인그레스도 감시하도록 설정
        watchIngressWithoutClass: true
        config:
          enable-modsecurity: "true"
          enable-owasp-modsecurity-crs: "true"
          modsecurity-snippet: |
            SecRuleEngine On
            SecRequestBodyAccess On
            SecAuditEngine RelevantOnly
            SecAuditLog /dev/stdout
    state: present

- name: "HTTPS용 자체 서명 인증서 생성 및 Secret 등록"
  ansible.builtin.shell: |
    if [ ! -f /tmp/tls.key ]; then
      openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /tmp/tls.key -out /tmp/tls.crt -subj "/CN=7th-room-waf"
    fi
    /usr/local/bin/kubectl create secret tls waf-tls-secret --cert=/tmp/tls.crt --key=/tmp/tls.key -n default --dry-run=client -o yaml | /usr/local/bin/kubectl apply -f -
  changed_when: false